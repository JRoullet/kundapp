<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta name="app-success" th:content="${success}" th:if="${success}"/>
    <meta name="app-error" th:content="${error}" th:if="${error}"/>
    <meta name="credits-operation" th:content="${creditsOperation}" th:if="${creditsOperation}"/>
    <meta name="new-credits" th:content="${newCredits}" th:if="${newCredits}"/>
    <title>Sessions | KundApp</title>
    <link th:href="@{/css/mdb.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/index.css}" rel="stylesheet"/>
</head>
<body>
<nav class="navbar navbar-expand-lg">
    <div class="container">
        <div class="logo me-3">
            <img th:src="@{/images/kundapplogo.jpg}" alt="KundApp Logo" />
        </div>
        <a class="navbar-brand" href="/client">KundApp</a>
        <button class="navbar-toggler" type="button" data-mdb-toggle="collapse" data-mdb-target="#navbarMain">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" href="/client">Sessions</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-mdb-toggle="dropdown">
                        <i class="fas fa-cog"></i>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/client/profile">Mon profil</a></li>
                    </ul>
                </li>
            </ul>
            <div class="d-flex align-items-center">
                <div class="credits-info me-3" th:if="${user != null}"
                     th:data-user-credits="${user.credits ?: 0}"
                     id="userCreditsDisplay">
                    <i class="fas fa-coins me-1"></i>
                    <span id="creditsCount" th:text="${user.credits ?: 0}">5</span> cr√©dits
                </div>
                <span class="me-3" th:if="${user != null}" th:text="${user.email}">client@kundapp.com</span>
                <form th:action="@{/logout}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-outline-primary">D√©connexion</button>
                </form>
            </div>
        </div>
    </div>
</nav>

<!-- Success/Error Messages -->
<div class="toast-container" id="toastContainer"></div>

<main class="container py-4">
    <!-- Page Header with Filters -->
    <div class="welcome-banner mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="h4 mb-0">Sessions</h1>
                <p class="mb-0">D√©couvrez et g√©rez vos s√©ances</p>
            </div>
            <div class="col-md-6">
                <!-- Filters Section -->
                <div class="search-filters-container">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <select class="form-select" id="subjectFilter">
                                <option value="">Toutes les cat√©gories</option>
                                <option value="YOGA">Yoga</option>
                                <option value="KUNDALINI">Kundalini</option>
                                <option value="PILATES">Pilates</option>
                                <option value="SOIN_ENERGETIQUE">Soin √©nerg√©tique</option>
                                <option value="MEDITATION">M√©ditation</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group w-100" role="group">
                                <input type="checkbox" class="btn-check" id="filterOnline" checked>
                                <label class="btn btn-outline-secondary filter-btn" for="filterOnline">En ligne</label>
                                <input type="checkbox" class="btn-check" id="filterIrl" checked>
                                <label class="btn btn-outline-secondary filter-btn" for="filterIrl">Pr√©sentiel</label>
                            </div>
                        </div>
                    </div>
                    <!-- Teacher Search -->
                    <div class="mt-2" id="teacherSearchContainer" style="display: none;">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Nom du professeur..." id="teacherSearch">
                            <button class="btn btn-outline-secondary" type="button" onclick="clearTeacherSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 text-end">
                        <button class="btn btn-link btn-sm p-0" onclick="toggleTeacherSearch()" id="toggleTeacherBtn">
                            <i class="fas fa-search me-1"></i>Rechercher par professeur
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="sessionTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="available-tab" data-mdb-toggle="tab" data-mdb-target="#available" type="button" role="tab">
                Sessions disponibles
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="upcoming-tab" data-mdb-toggle="tab" data-mdb-target="#upcoming" type="button" role="tab">
                Mes prochaines s√©ances
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-mdb-toggle="tab" data-mdb-target="#history" type="button" role="tab">
                Historique
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="sessionTabsContent">
        <!-- Available Sessions Tab -->
        <div class="tab-pane fade show active" id="available" role="tabpanel">
            <div class="row">
                <div th:each="sessionItem : ${sessions}"
                     class="col-12 mb-3"
                     data-session-card
                     th:data-subject="${sessionItem.subject}"
                     th:data-online="${sessionItem.isOnline}"
                     th:data-teacher="${sessionItem.teacherFirstName + ' ' + sessionItem.teacherLastName}">
                    <div class="session-card-content">

                        <!-- Info Button -->
                        <button class="btn btn-outline-secondary btn-sm description-btn-floating"
                                th:data-session-title="${sessionItem.subject}"
                                th:data-session-description="${sessionItem.description}"
                                th:data-teacher-name="${sessionItem.teacherFirstName + ' ' + sessionItem.teacherLastName}">
                            ‚ÑπÔ∏è
                        </button>

                        <div class="row g-0 align-items-center">
                            <!-- Colonne 1 - Gauche -->
                            <div class="col-4 session-col-left">
                                <div class="session-title-line">
                                    <h5 class="session-title mb-0 fw-bold" th:text="${sessionItem.subject}">PILATES</h5>
                                </div>
                                <div class="session-date-line">
                                    <small th:text="${#temporals.format(sessionItem.startDateTime, 'EEEE d MMMM yyyy')}">vendredi 1 ao√ªt 2025</small>
                                </div>
                                <div class="session-time-line">
                                    <small>
                                        <span th:text="${#temporals.format(sessionItem.startDateTime, 'HH:mm')}">01:00</span>
                                        -
                                        <span th:text="${#temporals.format(sessionItem.startDateTime.plusMinutes(sessionItem.durationMinutes), 'HH:mm')}">04:00</span>
                                    </small>
                                </div>
                            </div>

                            <!-- Colonne 2 - Milieu -->
                            <div class="col-4 session-col-center">
                                <div class="session-teacher-line">
                                <span class="fw-bold teacher-name">
                                    Prof. <span th:text="${sessionItem.teacherFirstName + ' ' + sessionItem.teacherLastName}">Jojo jojo</span>
                                </span>
                                </div>
                                <div class="session-room-line">
                                    <small>
                                        <th:block th:if="${sessionItem.isOnline}">
                                            <span class="session-online-badge">üíª En ligne</span>
                                        </th:block>
                                        <th:block th:unless="${sessionItem.isOnline}">
                                            <span th:text="${sessionItem.roomName ?: 'Lieu non d√©fini'}">Omvida</span>
                                        </th:block>
                                    </small>
                                </div>
                                <div class="session-participants-line">
                                    <small>
                                        <span th:text="${sessionItem.registeredParticipants}">0</span> participants
                                        (<span th:text="${sessionItem.availableSpots - sessionItem.registeredParticipants}">6</span> places)
                                    </small>
                                </div>
                            </div>

                            <!-- Colonne 3 - Droite -->
                            <div class="col-4 session-col-right">
                                <div class="session-register-line">
                                    <!-- PRIORIT√â 1: User d√©j√† inscrit -->
                                    <th:block th:if="${sessionItem.isUserRegistered != null && sessionItem.isUserRegistered}">
                                        <span class="badge bg-success">INSCRIT</span>
                                    </th:block>

                                    <!-- PRIORIT√â 2: Session compl√®te (et user pas inscrit) -->
                                    <th:block th:if="${sessionItem.isUserRegistered == null || !sessionItem.isUserRegistered}">
                                        <th:block th:if="${sessionItem.availableSpots <= sessionItem.registeredParticipants}">
                                            <button class="btn btn-secondary btn-sm" disabled>COMPLET</button>
                                        </th:block>

                                        <!-- PRIORIT√â 3: Session disponible pour inscription -->
                                        <th:block th:unless="${sessionItem.availableSpots <= sessionItem.registeredParticipants}">
                                            <button type="button" class="btn btn-primary btn-sm register-modal-btn"
                                                    th:data-session-id="${sessionItem.id}"
                                                    th:data-session-subject="${sessionItem.subject}"
                                                    th:data-session-date="${#temporals.format(sessionItem.startDateTime, 'EEEE d MMMM yyyy')}"
                                                    th:data-session-time="${#temporals.format(sessionItem.startDateTime, 'HH:mm')}"
                                                    th:data-session-end-time="${#temporals.format(sessionItem.startDateTime.plusMinutes(sessionItem.durationMinutes), 'HH:mm')}"
                                                    th:data-session-teacher="${sessionItem.teacherFirstName + ' ' + sessionItem.teacherLastName}"
                                                    th:data-session-type="${sessionItem.isOnline ? 'En ligne' : (sessionItem.roomName ?: 'Pr√©sentiel')}"
                                                    th:data-session-credits="${sessionItem.creditsRequired}">
                                                S'INSCRIRE
                                            </button>
                                        </th:block>
                                    </th:block>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MES PROCHAINES S√âANCES -->
        <div class="tab-pane fade" id="upcoming" role="tabpanel">
            <div class="row">
                <div th:each="upcomingSession : ${upcomingSessions}"
                     class="col-12 mb-3"
                     data-session-card
                     th:data-subject="${upcomingSession.subject}"
                     th:data-online="${upcomingSession.isOnline}"
                     th:data-teacher="${upcomingSession.teacherFirstName + ' ' + upcomingSession.teacherLastName}">                    <div class="session-card-content">
                        <!-- Badge Inscrit en overlay -->
                        <span class="badge bg-success badge-status-right">
                            Inscrit ‚úì
                        </span>

                        <!-- Info Button -->
                        <button class="btn btn-outline-secondary btn-sm description-btn-floating"
                                th:data-session-title="${upcomingSession.subject}"
                                th:data-session-description="${upcomingSession.description}"
                                th:data-teacher-name="${upcomingSession.teacherFirstName + ' ' + upcomingSession.teacherLastName}">
                            ‚ÑπÔ∏è
                        </button>

                        <div class="row g-0 align-items-center">
                            <!-- Colonne 1 - Gauche -->
                            <div class="col-4 session-col-left">
                                <div class="session-title-line">
                                    <h5 class="session-title mb-0 fw-bold" th:text="${upcomingSession.subject}">YOGA</h5>
                                </div>
                                <div class="session-date-line">
                                    <small th:text="${#temporals.format(upcomingSession.startDateTime, 'EEEE d MMMM yyyy')}">lundi 15 janvier 2025</small>
                                </div>
                                <div class="session-time-line">
                                    <small>
                                        <span th:text="${#temporals.format(upcomingSession.startDateTime, 'HH:mm')}">14:00</span>
                                        -
                                        <span th:text="${#temporals.format(upcomingSession.startDateTime.plusMinutes(upcomingSession.durationMinutes), 'HH:mm')}">15:00</span>
                                    </small>
                                </div>
                            </div>

                            <!-- Colonne 2 - Milieu -->
                            <div class="col-4 session-col-center">
                                <div class="session-teacher-line">
                                <span class="fw-bold teacher-name">
                                    Prof. <span th:text="${upcomingSession.teacherFirstName + ' ' + upcomingSession.teacherLastName}">Marie Dupont</span>
                                </span>
                                </div>
                                <div class="session-room-line">
                                    <small>
                                        <th:block th:if="${upcomingSession.isOnline}">
                                            <span class="session-online-badge">üíª En ligne</span>
                                        </th:block>
                                        <th:block th:unless="${upcomingSession.isOnline}">
                                            <span th:text="${upcomingSession.roomName ?: 'Lieu non d√©fini'}">Salle A</span>
                                        </th:block>
                                    </small>
                                </div>
                                <div class="session-participants-line">
                                    <small>
                                        <span th:text="${upcomingSession.registeredParticipants}">5</span> participants
                                        (<span th:text="${upcomingSession.availableSpots - upcomingSession.registeredParticipants}">3</span> places)
                                    </small>
                                </div>
                            </div>

                            <!-- Colonne 3 - Droite -->
                            <div class="col-4 session-col-right">
                                <div class="session-unregister-line">
                                    <button type="button" class="btn btn-outline-danger btn-sm unregister-modal-btn"
                                            th:data-session-id="${upcomingSession.id}"
                                            th:data-session-subject="${upcomingSession.subject}"
                                            th:data-session-date="${#temporals.format(upcomingSession.startDateTime, 'EEEE d MMMM yyyy')}"
                                            th:data-session-time="${#temporals.format(upcomingSession.startDateTime, 'HH:mm')}"
                                            th:data-session-teacher="${upcomingSession.teacherFirstName + ' ' + upcomingSession.teacherLastName}">
                                        SE D√âSINSCRIRE
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Message si aucune session -->
            <div class="text-center py-5" th:if="${#lists.isEmpty(upcomingSessions)}">
                <div class="text-muted">
                    <h5>Aucune s√©ance √† venir</h5>
                    <p>Vous n'avez pas encore de r√©servations.</p>
                </div>
            </div>
        </div>

        <!-- HISTORIQUE -->
        <div class="tab-pane fade" id="history" role="tabpanel">
            <div class="row">
                <div th:each="historySession : ${historySessions}"
                     class="col-12 mb-3"
                     data-session-card
                     th:data-status="${historySession.status}"
                     th:data-subject="${historySession.subject}"
                     th:data-online="${historySession.isOnline}"
                     th:data-teacher="${historySession.teacherFirstName + ' ' + historySession.teacherLastName}">
                    <div class="session-card-content">
                        <!-- Badge Status en overlay (comme "upcoming") -->
                        <span class="badge badge-status-right"
                              th:classappend="${historySession.status?.name() == 'CANCELLED'} ? 'bg-warning' : 'bg-secondary'">
                    <span th:text="${historySession.status?.name() == 'CANCELLED'} ? 'Annul√©e' : 'Termin√©e'">Termin√©e</span>
                </span>

                        <!-- Info Button -->
                        <button class="btn btn-outline-secondary btn-sm description-btn-floating"
                                th:data-session-title="${historySession.subject}"
                                th:data-session-description="${historySession.description}"
                                th:data-teacher-name="${historySession.teacherFirstName + ' ' + historySession.teacherLastName}">
                            ‚ÑπÔ∏è
                        </button>

                        <div class="row g-0 align-items-center">
                            <!-- Colonne 1 - Gauche -->
                            <div class="col-4 session-col-left">
                                <div class="session-title-line">
                                    <h5 class="session-title mb-0 fw-bold" th:text="${historySession.subject}">YOGA</h5>
                                </div>
                                <div class="session-date-line">
                                    <small th:text="${#temporals.format(historySession.startDateTime, 'EEEE d MMMM yyyy')}">lundi 15 janvier 2025</small>
                                </div>
                                <div class="session-time-line">
                                    <small>
                                        <span th:text="${#temporals.format(historySession.startDateTime, 'HH:mm')}">14:00</span>
                                        -
                                        <span th:text="${#temporals.format(historySession.startDateTime.plusMinutes(historySession.durationMinutes), 'HH:mm')}">15:00</span>
                                    </small>
                                </div>
                            </div>

                            <!-- Colonne 2 - Milieu -->
                            <div class="col-4 session-col-center">
                                <div class="session-teacher-line">
                            <span class="fw-bold teacher-name">
                                Prof. <span th:text="${historySession.teacherFirstName + ' ' + historySession.teacherLastName}">Marie Dupont</span>
                            </span>
                                </div>
                                <div class="session-room-line">
                                    <small>
                                        <th:block th:if="${historySession.isOnline}">
                                            <span class="session-online-badge">üíª En ligne</span>
                                        </th:block>
                                        <th:block th:unless="${historySession.isOnline}">
                                            <span th:text="${historySession.roomName ?: 'Lieu non d√©fini'}">Salle A</span>
                                        </th:block>
                                    </small>
                                </div>
                                <div class="session-participants-line">
                                    <small>
                                        <th:block th:if="${historySession.status?.name() == 'COMPLETED'}">Session termin√©e</th:block>
                                        <th:block th:if="${historySession.status?.name() == 'CANCELLED'}">Session annul√©e</th:block>
                                    </small>
                                </div>
                            </div>

                            <!-- Colonne 3 - Droite -->
                            <div class="col-4 session-col-right">
                                <div class="session-register-line">
                                    <!-- Zone vide pour coh√©rence ou informations additionnelles -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Message si aucune session -->
            <div class="text-center py-5" th:if="${#lists.isEmpty(historySessions)}">
                <div class="text-muted">
                    <h5>Aucun historique</h5>
                    <p>Vous n'avez pas encore particip√© √† des sessions.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Session Description -->
    <div class="modal fade" id="sessionDescriptionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sessionDescriptionTitle">Description de la session</h5>
                    <button type="button" class="btn-close" data-mdb-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="sessionDescriptionContent">Contenu de la description...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Registration Confirmation -->
    <div class="modal fade" id="registrationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-calendar-check me-2"></i>Confirmer votre inscription
                    </h5>
                    <button type="button" class="btn-close" data-mdb-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0" id="regModalSubject">YOGA</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-2">
                                        <i class="fas fa-calendar me-2 text-primary"></i>
                                        <strong>Date :</strong><br>
                                        <span id="regModalDate">Lundi 15 janvier 2025</span>
                                    </p>
                                    <p class="mb-2">
                                        <i class="fas fa-clock me-2 text-primary"></i>
                                        <strong>Horaire :</strong><br>
                                        <span id="regModalTime">14:00 - 15:00</span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2">
                                        <i class="fas fa-chalkboard-teacher me-2 text-primary"></i>
                                        <strong>Professeur :</strong><br>
                                        <span id="regModalTeacher">Marie Dupont</span>
                                    </p>
                                    <p class="mb-2">
                                        <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                        <strong>Type :</strong><br>
                                        <span id="regModalType">En ligne</span>
                                    </p>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-info d-flex align-items-center">
                                        <i class="fas fa-coins me-2"></i>
                                        <strong>Co√ªt : <span id="regModalCredits">1</span> cr√©dit(s)</strong>
                                    </div>
                                    <div class="alert alert-warning">
                                        <small><i class="fas fa-info-circle me-1"></i>Toute annulation doit avoir lieu 48h minimum avant le d√©but de la s√©ance.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Annuler
                    </button>
                    <form id="regConfirmForm" method="post" class="d-inline">
                        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check me-1"></i>Confirmer mon inscription √† la s√©ance
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Unregistration Confirmation -->
    <div class="modal fade" id="unregistrationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>Confirmer l'annulation
                    </h5>
                    <button type="button" class="btn-close" data-mdb-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>√ätes-vous s√ªr de vouloir vous d√©sinscrire de cette s√©ance ?</strong></p>
                    <div class="alert alert-info">
                        <div><strong id="unregModalSubject">YOGA</strong></div>
                        <div><span id="unregModalDate">Lundi 15 janvier 2025</span> √† <span id="unregModalTime">14:00</span></div>
                        <div>Prof. <span id="unregModalTeacher">Marie Dupont</span></div>
                    </div>
                    <div class="alert alert-warning">
                        <small><i class="fas fa-info-circle me-1"></i>Vos cr√©dits seront rembours√©s si l'annulation respecte le d√©lai de 48h.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Garder mon inscription</button>
                    <form id="unregConfirmForm" method="post" class="d-inline">
                        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="fas fa-times me-1"></i>Confirmer l'annulation
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<footer class="py-3 mt-5 bg-white border-top">
    <div class="container">
        <p class="text-center text-muted mb-0">¬© 2025 KundApp. Tous droits r√©serv√©s.</p>
    </div>
</footer>

<!-- Scripts -->
<script th:src="@{/js/common.js}"></script>
<script th:src="@{/js/client.js}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.js"></script>
</body>
</html>