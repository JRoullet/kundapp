<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta name="app-success" th:content="${success}" th:if="${success}"/>
    <meta name="app-error" th:content="${error}" th:if="${error}"/>
    <title>Sessions | KundApp</title>
    <link th:href="@{/css/mdb.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/index.css}" rel="stylesheet"/>
</head>
<body>
<nav class="navbar navbar-expand-lg">
    <div class="container">
        <div class="logo me-3">
            <img th:src="@{/images/kundapplogo.jpg}" alt="KundApp Logo" />
        </div>
        <a class="navbar-brand" href="/client">KundApp</a>
        <button class="navbar-toggler" type="button" data-mdb-toggle="collapse" data-mdb-target="#navbarMain">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" href="/client/sessions">Sessions</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-mdb-toggle="dropdown">
                        <i class="fas fa-cog"></i>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/client/profile">Mon profil</a></li>
                    </ul>
                </li>
            </ul>
            <div class="d-flex align-items-center">
                <div class="credits-info me-3" th:if="${user != null}"
                     th:data-user-credits="${user.credits ?: 0}">
                    <i class="fas fa-coins me-1"></i>
                    <span th:text="${user.credits ?: 0}">5</span> cr√©dits
                </div>
                <span class="me-3" th:if="${user != null}" th:text="${user.email}">client@kundapp.com</span>
                <form th:action="@{/logout}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-outline-primary">D√©connexion</button>
                </form>
            </div>
        </div>
    </div>
</nav>

<!-- Success/Error Messages -->
<div class="toast-container" id="toastContainer"></div>

<main class="container py-4">
    <!-- Page Header with Filters -->
    <div class="welcome-banner mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="h4 mb-0">Sessions</h1>
                <p class="mb-0">D√©couvrez et g√©rez vos s√©ances</p>
            </div>
            <div class="col-md-6">
                <!-- Filters Section -->
                <div class="search-filters-container">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <select class="form-select" id="subjectFilter">
                                <option value="">Toutes les cat√©gories</option>
                                <option value="YOGA">Yoga</option>
                                <option value="KUNDALINI">Kundalini</option>
                                <option value="PILATES">Pilates</option>
                                <option value="SOIN_ENERGETIQUE">Soin √©nerg√©tique</option>
                                <option value="MEDITATION">M√©ditation</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group w-100" role="group">
                                <input type="checkbox" class="btn-check" id="filterOnline" checked>
                                <label class="btn btn-outline-secondary filter-btn" for="filterOnline">En ligne</label>
                                <input type="checkbox" class="btn-check" id="filterIrl" checked>
                                <label class="btn btn-outline-secondary filter-btn" for="filterIrl">Pr√©sentiel</label>
                            </div>
                        </div>
                    </div>
                    <!-- Teacher Search -->
                    <div class="mt-2" id="teacherSearchContainer" style="display: none;">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Nom du professeur..." id="teacherSearch">
                            <button class="btn btn-outline-secondary" type="button" onclick="clearTeacherSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 text-end">
                        <button class="btn btn-link btn-sm p-0" onclick="toggleTeacherSearch()" id="toggleTeacherBtn">
                            <i class="fas fa-search me-1"></i>Rechercher par professeur
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="sessionTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="available-tab" data-mdb-toggle="tab" data-mdb-target="#available" type="button" role="tab">
                Sessions disponibles
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="upcoming-tab" data-mdb-toggle="tab" data-mdb-target="#upcoming" type="button" role="tab">
                Mes sessions √† venir
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-mdb-toggle="tab" data-mdb-target="#history" type="button" role="tab">
                Historique
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="sessionTabsContent">
        <!-- Available Sessions Tab -->
        <div class="tab-pane fade show active" id="available" role="tabpanel">
            <div class="row">
                <div th:each="sessionItem : ${sessions}"
                     class="col-12 mb-3"
                     data-session-card
                     th:data-subject="${sessionItem.subject}"
                     th:data-online="${sessionItem.isOnline}"
                     th:data-teacher="${sessionItem.teacherFirstName + ' ' + sessionItem.teacherLastName}">
                    <div class="session-card-content">
                        <!-- Info Button -->
                        <button class="btn btn-outline-secondary btn-sm description-btn-floating"
                                th:data-session-title="${sessionItem.subject}"
                                th:data-session-description="${sessionItem.description}"
                                title="Voir la description">
                            ‚ÑπÔ∏è
                        </button>
                        <div class="row g-0 align-items-center">
                            <!-- Colonne 1 - Gauche -->
                            <div class="col-4 session-col-left">
                                <div class="session-title-line">
                                    <h5 class="session-title mb-0 fw-bold" th:text="${sessionItem.subject}">PILATES</h5>
                                </div>
                                <div class="session-date-line">
                                    <small th:text="${#temporals.format(sessionItem.startDateTime, 'EEEE d MMMM yyyy')}">vendredi 1 ao√ªt 2025</small>
                                </div>
                                <div class="session-time-line">
                                    <small>
                                        <span th:text="${#temporals.format(sessionItem.startDateTime, 'HH:mm')}">01:00</span>
                                        -
                                        <span th:text="${#temporals.format(sessionItem.startDateTime.plusMinutes(sessionItem.durationMinutes), 'HH:mm')}">04:00</span>
                                    </small>
                                </div>
                            </div>

                            <!-- Colonne 2 - Milieu -->
                            <div class="col-4 session-col-center">
                                <div class="session-teacher-line">
                                        <span class="fw-bold teacher-name">
                                            Prof. <span th:text="${sessionItem.teacherFirstName + ' ' + sessionItem.teacherLastName}">Jojo jojo</span>
                                        </span>
                                </div>
                                <div class="session-room-line">
                                    <small>
                                        <th:block th:if="${sessionItem.isOnline}">
                                            <span class="session-online-badge">üíª En ligne</span>
                                        </th:block>
                                        <th:block th:unless="${sessionItem.isOnline}">
                                            <span th:text="${sessionItem.roomName ?: 'Lieu non d√©fini'}">Omvida</span>
                                        </th:block>
                                    </small>
                                </div>
                                <div class="session-participants-line">
                                    <small>
                                        <span th:text="${sessionItem.registeredParticipants}">0</span> participants
                                        (<span th:text="${sessionItem.availableSpots - sessionItem.registeredParticipants}">6</span> places)
                                    </small>
                                </div>
                            </div>

                            <!-- Colonne 3 - Droite -->
                            <div class="col-4 session-col-right">
                                <div class="session-register-line">
                                    <th:block th:if="${sessionItem.isUserRegistered}">
                                        <button class="btn btn-outline-danger btn-sm unregister-btn"
                                                th:data-session-id="${sessionItem.id}">
                                            SE D√âSINSCRIRE
                                        </button>
                                    </th:block>
                                    <th:block th:unless="${sessionItem.isUserRegistered}">
                                        <th:block th:if="${sessionItem.availableSpots <= sessionItem.registeredParticipants}">
                                            <button class="btn btn-secondary btn-sm disabled" disabled>COMPLET</button>
                                        </th:block>
                                        <th:block th:unless="${sessionItem.availableSpots <= sessionItem.registeredParticipants}">
                                            <button class="btn btn-primary btn-sm register-btn" th:data-session-id="${sessionItem.id}">S'INSCRIRE</button>
                                        </th:block>
                                    </th:block>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming Sessions Tab -->
        <div class="tab-pane fade" id="upcoming" role="tabpanel">
            <div class="row">
                <div th:each="session : ${upcomingSessions}"
                     class="col-12 mb-3"
                     data-session-card
                     th:data-subject="${session.subject}"
                     th:data-online="${session.isOnline}"
                     th:data-teacher="${session.teacherFirstName + ' ' + session.teacherLastName}">
                    <div class="card session-card border-0 shadow-sm" th:data-session-id="${session.id}">
                        <div class="card-body">
                            <div class="session-card-content">
                                <!-- Left - Date/Time/Location -->
                                <div class="session-info-left">
                                    <h5 class="session-title mb-2 fw-bold" th:text="${session.subject}">Yoga</h5>
                                    <p class="mb-1">
                                        <i class="fas fa-calendar me-2 text-muted"></i>
                                        <small th:text="${#temporals.format(sessionItem.startDateTime, 'EEEE d MMMM yyyy', T(java.util.Locale).FRANCE)}">Lundi 15 janvier 2025</small>
                                    </p>
                                    <p class="mb-1">
                                        <i class="fas fa-clock me-2 text-muted"></i>
                                        <small>
                                            <span th:text="${#temporals.format(session.startDateTime, 'HH:mm')}">14:00</span>
                                            -
                                            <span th:text="${#temporals.format(session.endDateTime, 'HH:mm')}">15:00</span>
                                        </small>
                                    </p>
                                    <p class="mb-0">
                                        <th:block th:if="${session.isOnline}">
                                            <small>üíª En ligne</small>
                                        </th:block>
                                        <th:block th:unless="${session.isOnline}">
                                            <i class="fas fa-map-marker-alt me-2 text-muted"></i>
                                            <small th:text="${session.roomName ?: 'Lieu non d√©fini'}">Salle A</small>
                                        </th:block>
                                    </p>
                                </div>

                                <!-- Center - Teacher/Room/Participants -->
                                <div class="session-info-center">
                                    <p class="mb-2 fw-bold teacher-name">
                                        Prof. <span th:text="${session.teacherFirstName + ' ' + session.teacherLastName}">Marie Dupont</span>
                                    </p>
                                    <p class="mb-1">
                                        <i class="fas fa-door-open me-2 text-muted"></i>
                                        <small th:text="${session.roomName ?: 'Salle non d√©finie'}">Salle A</small>
                                    </p>
                                    <p class="mb-0">
                                        <i class="fas fa-users me-2 text-muted"></i>
                                        <small>
                                            <span th:text="${session.registeredParticipants}">5</span> participants
                                            (<span th:text="${session.availableSpots - session.registeredParticipants}">3</span> places)
                                        </small>
                                    </p>
                                </div>

                                <!-- Right - Action Buttons -->
                                <div class="session-action-right">
                                    <div class="d-flex flex-column gap-2 align-items-center">
                                        <!-- Registration Status Badge -->
                                        <div th:if="${sessionItem.isUserRegistered}">
                                            <span class="badge bg-success mb-2">Inscrit ‚úì</span>
                                        </div>

                                        <!-- Action Button (centered) -->
                                        <div class="action-button-container">
                                            <th:block th:if="${sessionItem.isUserRegistered}">
                                                <button class="btn btn-outline-danger btn-sm"
                                                        th:onclick="'unregisterFromSession(' + ${sessionItem.id} + ')'">
                                                    <i class="fas fa-times me-1"></i>Se d√©sinscrire
                                                </button>
                                            </th:block>
                                            <th:block th:unless="${sessionItem.isUserRegistered}">
                                                <!-- Session compl√®te -->
                                                <th:block th:if="${sessionItem.availableSpots <= sessionItem.registeredParticipants}">
                                                    <button class="btn btn-secondary btn-sm disabled" disabled>
                                                        <i class="fas fa-calendar-plus me-1"></i>Complet
                                                    </button>
                                                </th:block>
                                                <!-- Session disponible -->
                                                <th:block th:unless="${sessionItem.availableSpots <= sessionItem.registeredParticipants}">
                                                    <button class="btn btn-primary btn-sm"
                                                            th:onclick="'registerForSession(' + ${sessionItem.id} + ')'">
                                                        <i class="fas fa-calendar-plus me-1"></i>S'inscrire
                                                    </button>
                                                </th:block>
                                            </th:block>
                                        </div>

                                        <!-- Description Button -->
                                        <button class="btn btn-outline-secondary btn-sm"
                                                th:onclick="'showDescription(\'' + ${sessionItem.subject} + '\', \'' + ${sessionItem.description} + '\')'">
                                            <i class="fas fa-info-circle me-1"></i>Description
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Message si aucune session -->
            <div class="text-center py-5" th:if="${#lists.isEmpty(upcomingSessions)}">
                <div class="text-muted">
                    <i class="fas fa-calendar-check fa-3x mb-3"></i>
                    <h5>Aucune session √† venir</h5>
                    <p>Vous n'avez pas encore de r√©servations.</p>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-pane fade" id="history" role="tabpanel">
            <div class="row">
                <div th:each="session : ${historySessions}" class="col-12 mb-3">
                    <div class="card session-card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="session-card-content">
                                <!-- Left - Date/Time/Location -->
                                <div class="session-info-left">
                                    <h5 class="session-title mb-2 fw-bold" th:text="${session.subject}">Yoga</h5>
                                    <p class="mb-1">
                                        <i class="fas fa-calendar me-2 text-muted"></i>
                                        <small th:text="${#temporals.format(session.startDateTime, 'EEEE d MMMM yyyy', 'fr')}">Lundi 15 janvier 2025</small>
                                    </p>
                                    <p class="mb-1">
                                        <i class="fas fa-clock me-2 text-muted"></i>
                                        <small th:text="${#temporals.format(session.startDateTime, 'HH:mm')}">14:00</small>
                                    </p>
                                    <p class="mb-0">
                                        <th:block th:if="${session.isOnline}">
                                            <i class="fas fa-video me-2 text-muted"></i><small>En ligne</small>
                                        </th:block>
                                        <th:block th:unless="${session.isOnline}">
                                            <i class="fas fa-map-marker-alt me-2 text-muted"></i>
                                            <small th:text="${session.roomName}">Salle A</small>
                                        </th:block>
                                    </p>
                                </div>

                                <!-- Center - Teacher/Room -->
                                <div class="session-info-center">
                                    <p class="mb-2 fw-bold teacher-name">
                                        Prof. <span th:text="${session.teacherFirstName + ' ' + session.teacherLastName}">Marie Dupont</span>
                                    </p>
                                    <p class="mb-0">
                                        <i class="fas fa-door-open me-2 text-muted"></i>
                                        <small th:text="${session.roomName}">Salle A</small>
                                    </p>
                                </div>

                                <!-- Right - Status -->
                                <div class="session-action-right">
                                    <div class="d-flex flex-column gap-2 align-items-center">
                                        <span class="badge bg-success mb-2">Termin√©e</span>
                                        <button class="btn btn-outline-secondary btn-sm"
                                                th:onclick="'showDescription(\'' + ${session.subject} + '\', \'' + ${session.description} + '\')'">
                                            <i class="fas fa-info-circle me-1"></i>Description
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Message si aucune session -->
            <div class="text-center py-5" th:if="${#lists.isEmpty(historySessions)}">
                <div class="text-muted">
                    <i class="fas fa-history fa-3x mb-3"></i>
                    <h5>Aucun historique</h5>
                    <p>Vous n'avez pas encore particip√© √† des sessions.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Session Description -->
    <div class="modal fade" id="sessionDescriptionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sessionDescriptionTitle">Description de la session</h5>
                    <button type="button" class="btn-close" data-mdb-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="sessionDescriptionContent">Contenu de la description...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>
</main>

<footer class="py-3 mt-5 bg-white border-top">
    <div class="container">
        <p class="text-center text-muted mb-0">¬© 2025 KundApp. Tous droits r√©serv√©s.</p>
    </div>
</footer>

<!-- Scripts -->
<script th:src="@{/js/common.js}"></script>
<script th:src="@{/js/client.js}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.js"></script>
</body>
</html>