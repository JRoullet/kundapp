<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration | KundApp Admin</title>
    <link th:href="@{/css/mdb.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/index.css}" rel="stylesheet"/>
</head>
<body class="admin">
<!-- Admin Navigation -->
<nav class="navbar navbar-expand-lg admin-navbar">
    <div class="container">
        <div class="logo me-3">
            <img th:src="@{/images/kundapplogo.jpg}" alt="KundApp Logo" />
        </div>
        <a class="navbar-brand" href="/admin">KundApp Admin</a>
        <button class="navbar-toggler" type="button" data-mdb-toggle="collapse" data-mdb-target="#navbarMain">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
            <div class="d-flex align-items-center ms-auto">
                <span class="me-3 admin-user-info" th:if="${user != null}" th:text="${user.email}">admin@kundapp.com</span>
                <form th:action="@{/logout}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-outline-light admin-logout-btn">
                        Déconnexion
                    </button>
                </form>
            </div>
        </div>
    </div>
</nav>

<div class="container py-4">
    <!-- Page Header -->
    <div class="admin-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="admin-title">Administration KundApp</h1>
                <p class="admin-subtitle">Gestion des utilisateurs et du système</p>
            </div>
        </div>
    </div>

    <!-- Global Search Section -->
    <div class="admin-search-global mb-4" id="searchSection">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <button class="btn btn-sm btn-outline-secondary me-2" id="toggleSearchBtn" onclick="toggleSearchSection()">
                        <span id="searchIcon">▼</span>
                    </button>
                    <h6 class="card-title mb-0">Recherche</h6>
                </div>
                <div class="row" id="searchFields">
                    <div class="col-md-4">
                        <label class="form-label">Prénom</label>
                        <input type="text" class="form-control" id="globalFirstNameSearch"
                               placeholder="Rechercher par prénom..." oninput="filterCurrentTab()">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Nom</label>
                        <input type="text" class="form-control" id="globalLastNameSearch"
                               placeholder="Rechercher par nom..." oninput="filterCurrentTab()">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-block">
                            <button class="btn btn-admin-secondary" style="padding: 12px 24px; font-weight: 600; border-radius: 8px; min-width: 120px;" onclick="clearGlobalSearch()">
                                Effacer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show admin-alert">
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-mdb-dismiss="alert"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show admin-alert">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-mdb-dismiss="alert"></button>
    </div>

    <!-- Admin Tabs -->
    <div class="admin-card">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs admin-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="teachers-tab" data-mdb-toggle="tab"
                        data-mdb-target="#teachers-content" type="button" role="tab">
                    Teachers
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="users-tab" data-mdb-toggle="tab"
                        data-mdb-target="#users-content" type="button" role="tab">
                    Clients
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="adminTabsContent">

            <!-- TEACHERS TAB -->
            <div class="tab-pane fade show active" id="teachers-content" role="tabpanel">
                <div class="admin-card-header" style="background: white; color: var(--admin-primary); padding: 20px; border-bottom: 3px solid white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="admin-card-title mb-0">Liste des Teachers</h5>
                        <button class="btn btn-admin-primary" style="border: 2px solid white !important;" onclick="openCreateTeacherModal()">
                            Nouveau Teacher
                        </button>
                    </div>
                </div>

                <!-- Teachers Table -->
                <div class="admin-table-container" style="margin-top: 15px; border-radius: 0;">
                    <table class="table admin-table">
                        <thead>
                        <tr>
                            <th>Prénom</th>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>Téléphone</th>
                            <th>Statut</th>
                            <th>Créé le</th>
                            <th class="text-center">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="teacher : ${users}" th:if="${teacher.role.name() == 'TEACHER'}" class="admin-table-row teacher-row">
                            <td th:text="${teacher.firstName}">Marie</td>
                            <td th:text="${teacher.lastName}">Martin</td>
                            <td><span class="admin-email" th:text="${teacher.email}">marie@example.com</span></td>
                            <td th:text="${teacher.phoneNumber != null ? teacher.phoneNumber : '-'}">06 12 34 56 78</td>
                            <td>
                                <span th:class="${teacher.status} ? 'admin-status admin-status-active' : 'admin-status admin-status-inactive'">
                                    <span th:text="${teacher.status} ? 'Actif' : 'Inactif'">Actif</span>
                                </span>
                            </td>
                            <td th:text="${#temporals.format(teacher.createdAt, 'dd/MM/yyyy')}">01/01/2025</td>
                            <td class="text-center admin-actions">
                                <div class="admin-action-buttons">
                                    <button class="btn btn-admin-edit" th:onclick="|openEditTeacherModal(${teacher.id})|" title="Modifier">
                                        Modifier
                                    </button>
                                    <button class="btn btn-admin-disable" th:onclick="|confirmDisableTeacher(${teacher.id})|" title="Désactiver">
                                        Désactiver
                                    </button>
                                    <button class="btn btn-admin-delete" th:onclick="|confirmDeleteTeacher(${teacher.id})|" title="Supprimer">
                                        Supprimer
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <!-- Empty state pour teachers -->
                        <tr th:if="${users == null || users.isEmpty()}" class="admin-empty-state">
                            <td colspan="7" class="text-center py-5">
                                <div class="admin-empty-content">
                                    <h5 class="admin-empty-title">Aucun teacher trouvé</h5>
                                    <p class="admin-empty-text">Créer un teacher</p>
                                    <button class="btn btn-admin-primary" style="border: 2px solid white !important;" onclick="openCreateTeacherModal()">
                                        Créer un teacher
                                    </button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- USERS TAB -->
            <div class="tab-pane fade" id="users-content" role="tabpanel">
                <div class="admin-card-header" style="background: white; color: var(--admin-primary); padding: 20px; border-bottom: 3px solid white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="admin-card-title mb-0">Liste des Clients</h5>
                        <button class="btn btn-admin-primary" style="border: 2px solid white !important;" onclick="openCreateUserModal()">
                            Nouveau Client
                        </button>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="admin-table-container" style="margin-top: 15px; border-radius: 0;">
                    <table class="table admin-table">
                        <thead>
                        <tr>
                            <th>Prénom</th>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>Statut</th>
                            <th>Crédits</th>
                            <th>Créé le</th>
                            <th class="text-center">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="user : ${users}" th:if="${user.role.name() == 'CLIENT'}" class="admin-table-row user-row">
                            <td th:text="${user.firstName}">John</td>
                            <td th:text="${user.lastName}">Doe</td>
                            <td><span class="admin-email" th:text="${user.email}">john@example.com</span></td>
                            <td>
                                <span th:class="${user.status} ? 'admin-status admin-status-active' : 'admin-status admin-status-inactive'">
                                    <span th:text="${user.status} ? 'Actif' : 'Inactif'">Actif</span>
                                </span>
                            </td>
                            <td th:text="${user.credits != null ? user.credits : '0'}">5</td>
                            <td th:text="${#temporals.format(user.createdAt, 'dd/MM/yyyy')}">01/01/2025</td>
                            <td class="text-center admin-actions">
                                <div class="admin-action-buttons">
                                    <button class="btn btn-admin-edit" th:onclick="|openEditUserModal(${user.id})|" title="Modifier">
                                        Modifier
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" th:onclick="|openCreditsModal(${user.id})|" title="Gérer crédits">
                                        Crédits
                                    </button>
                                    <button class="btn btn-admin-disable" th:onclick="|confirmDisableUser(${user.id})|" title="Désactiver">
                                        Désactiver
                                    </button>
                                    <button class="btn btn-admin-delete" th:onclick="|confirmDeleteUser(${user.id})|" title="Supprimer">
                                        Supprimer
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <!-- Empty state pour users -->
                        <tr th:if="${users == null || users.isEmpty()}" class="admin-empty-state">
                            <td colspan="7" class="text-center py-5">
                                <div class="admin-empty-content">
                                    <h5 class="admin-empty-title">Aucun client trouvé</h5>
                                    <p class="admin-empty-text">Créer votre premier client</p>
                                    <button class="btn btn-admin-primary" style="border: 2px solid white !important;" onclick="openCreateUserModal()">
                                        Créer un client
                                    </button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Teacher Modal -->
<div class="modal fade" id="teacherModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teacherModalTitle">Créer un Teacher</h5>
                <button type="button" class="btn-close" data-mdb-dismiss="modal"></button>
            </div>
            <form id="teacherForm" action="/admin/teachers" method="post">
                <div class="modal-body">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" id="teacherId" name="id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="teacherFirstName" class="form-label">Prénom *</label>
                            <input type="text" class="form-control" id="teacherFirstName" name="firstName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="teacherLastName" class="form-label">Nom *</label>
                            <input type="text" class="form-control" id="teacherLastName" name="lastName" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="teacherEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="teacherEmail" name="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="teacherPhone" class="form-label">Téléphone</label>
                            <input type="tel" class="form-control" id="teacherPhone" name="phoneNumber">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="teacherPassword" class="form-label">Mot de passe *</label>
                            <input type="password" class="form-control" id="teacherPassword" name="password" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="teacherBirthDate" class="form-label">Date de naissance</label>
                            <input type="date" class="form-control" id="teacherBirthDate" name="dateOfBirth">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="teacherBiography" class="form-label">Biographie</label>
                        <textarea class="form-control" id="teacherBiography" name="biography" rows="3"></textarea>
                    </div>

                    <!-- Section Adresse -->
                    <hr>
                    <h6 class="mb-3">Adresse</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="teacherStreet" class="form-label">Rue</label>
                            <input type="text" class="form-control" id="teacherStreet" name="address.street">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="teacherCity" class="form-label">Ville</label>
                            <input type="text" class="form-control" id="teacherCity" name="address.city">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="teacherZipCode" class="form-label">Code postal</label>
                            <input type="text" class="form-control" id="teacherZipCode" name="address.zipCode">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="teacherCountry" class="form-label">Pays</label>
                            <input type="text" class="form-control" id="teacherCountry" name="address.country">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Teacher Update Modal - Modification SANS password -->
<div class="modal fade" id="teacherUpdateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier le Teacher</h5>
                <button type="button" class="btn-close" data-mdb-dismiss="modal"></button>
            </div>
            <form id="teacherUpdateForm" method="post">
                <div class="modal-body">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" id="teacherUpdateId" name="id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="teacherUpdateFirstName" class="form-label">Prénom *</label>
                            <input type="text" class="form-control" id="teacherUpdateFirstName" name="firstName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="teacherUpdateLastName" class="form-label">Nom *</label>
                            <input type="text" class="form-control" id="teacherUpdateLastName" name="lastName" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="teacherUpdateEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="teacherUpdateEmail" name="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="teacherUpdatePhone" class="form-label">Téléphone</label>
                            <input type="tel" class="form-control" id="teacherUpdatePhone" name="phoneNumber">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="teacherUpdateBirthDate" class="form-label">Date de naissance</label>
                            <input type="date" class="form-control" id="teacherUpdateBirthDate" name="dateOfBirth">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="teacherUpdateBiography" class="form-label">Biographie</label>
                        <textarea class="form-control" id="teacherUpdateBiography" name="biography" rows="3"></textarea>
                    </div>

                    <!-- Section Adresse -->
                    <hr>
                    <h6 class="mb-3">Adresse</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="teacherUpdateStreet" class="form-label">Rue</label>
                            <input type="text" class="form-control" id="teacherUpdateStreet" name="address.street">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="teacherUpdateCity" class="form-label">Ville</label>
                            <input type="text" class="form-control" id="teacherUpdateCity" name="address.city">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="teacherUpdateZipCode" class="form-label">Code postal</label>
                            <input type="text" class="form-control" id="teacherUpdateZipCode" name="address.zipCode">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="teacherUpdateCountry" class="form-label">Pays</label>
                            <input type="text" class="form-control" id="teacherUpdateCountry" name="address.country">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Mettre à jour</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- User Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">Créer un Client</h5>
                <button type="button" class="btn-close" data-mdb-dismiss="modal"></button>
            </div>
            <form id="userForm" action="/admin/users" method="post">
                <div class="modal-body">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" id="userId" name="id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="userFirstName" class="form-label">Prénom *</label>
                            <input type="text" class="form-control" id="userFirstName" name="firstName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="userLastName" class="form-label">Nom *</label>
                            <input type="text" class="form-control" id="userLastName" name="lastName" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="userEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="userEmail" name="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="userPhone" class="form-label">Téléphone</label>
                            <input type="tel" class="form-control" id="userPhone" name="phoneNumber">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="userPassword" class="form-label">Mot de passe *</label>
                            <input type="password" class="form-control" id="userPassword" name="password" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="userBirthDate" class="form-label">Date de naissance</label>
                            <input type="date" class="form-control" id="userBirthDate" name="dateOfBirth">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="userCredits" class="form-label">Crédits</label>
                            <input type="number" class="form-control" id="userCredits" name="credits" min="0" value="0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Credits Modal -->
<div class="modal fade" id="creditsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gestion des crédits</h5>
                <button type="button" class="btn-close" data-mdb-dismiss="modal"></button>
            </div>
            <form action="/admin/users/credits" method="post">
                <div class="modal-body">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" id="creditsUserId" name="userId">
                    <div class="mb-3">
                        <label for="newCredits" class="form-label">Nombre de crédits</label>
                        <input type="number" class="form-control" id="newCredits" name="credits" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Mettre à jour</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationTitle">Confirmation</h5>
                <button type="button" class="btn-close" data-mdb-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmButton">Confirmer</button>
            </div>
        </div>
    </div>
</div>

<footer class="admin-footer">
    <div class="container">
        <p class="text-center mb-0">© 2025 KundApp Admin. Tous droits réservés.</p>
    </div>
</footer>

<script th:src="@{/js/admin.js}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.js"></script>
</body>
</html>